<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>タルサ市 メンタルヘルス支援ナビ（MVP）</title>
    <!-- Base & layout -->
    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" href="css/layout.css" />

    <!-- Components -->
    <link rel="stylesheet" href="css/components/buttons.css" />
    <link rel="stylesheet" href="css/components/forms.css" />
    <link rel="stylesheet" href="css/components/results.css" />
    <link rel="stylesheet" href="css/components/agency.css" />
    <script defer src="js/components/banner.js"></script>
    <script defer src="js/components/emergency.js"></script>
    <script defer src="js/components/highcare.js"></script>
    <script defer src="js/components/youth.js"></script>
    <script defer src="js/components/adult-crisis.js"></script>
  </head>
  <body>
    <div class="container">
      <mh-banner></mh-banner>

      <main class="card" aria-live="polite">
        <h1 class="title" data-i18n="title">タルサ市 メンタルヘルス支援ナビ</h1>
        <p class="subtitle" data-i18n="subtitle">
          このツールは、あなたのニーズに合った支援につながるためのガイドです。いくつかの質問にお答えください（個人情報は保存しません）。
        </p>

        <!-- STEP A: 第一次トリアージ -->
        <section id="stepA" class="step" aria-labelledby="qA">
          <div class="q" id="qA" data-i18n="A.question">
            A.
            あなた、または他の誰かが差し迫った危険にありますか？または医学的な緊急事態ですか？
          </div>
          <div class="btn-row">
            <button
              class="btn btn-danger"
              data-next="emergency"
              data-i18n="A.yes"
            >
              はい（緊急）
            </button>
            <button class="btn" data-next="stepB" data-i18n="A.no">
              いいえ
            </button>
          </div>
        </section>

        <!-- STEP B: 年齢 -->
        <section id="stepB" class="step hidden" aria-labelledby="qB">
          <div class="q" id="qB" data-i18n="B.question">
            B. 助けを必要としているのは18歳以上の方ですか？
          </div>
          <div class="btn-row">
            <button class="btn" data-next="stepC" data-i18n="B.adultYes">
              はい（成人）
            </button>
            <button
              class="btn btn-outline"
              data-next="youth"
              data-i18n="B.minorNo"
            >
              いいえ（未成年）
            </button>
          </div>
        </section>

        <!-- STEP C: 成人・緊急度 -->
        <section id="stepC" class="step hidden" aria-labelledby="qC">
          <div class="q" id="qC" data-i18n="C.question">
            C.
            あなたは危機的な状況にあり、今すぐ、緊急に誰かと話す必要がありますか？
          </div>
          <div class="btn-row">
            <button
              class="btn btn-danger"
              data-next="adult-crisis"
              data-i18n="C.yes"
            >
              はい（今すぐ支援が必要）
            </button>
            <button class="btn" data-next="stepD" data-i18n="C.no">
              いいえ（落ち着いて相談先を探したい）
            </button>
          </div>
        </section>

        <!-- STEP D: 成人・特定ニーズ -->
        <section id="stepD" class="step hidden" aria-labelledby="qD">
          <div class="q" id="qD" data-i18n="D.question">
            D. 本日、助けを求めている主な理由は何ですか？（複数選択可）
          </div>
          <div class="checkboxes" role="group" aria-labelledby="qD">
            <label
              ><input type="checkbox" value="detox" /><span
                data-i18n="D.options.detox"
                >薬物やアルコールの使用を安全にやめたい（デトックス）</span
              ></label
            >
            <label
              ><input type="checkbox" value="psychosis" /><span
                data-i18n="D.options.psychosis"
                >幻覚や深刻な混乱を経験している</span
              ></label
            >
            <label
              ><input type="checkbox" value="therapy" /><span
                data-i18n="D.options.therapy"
                >カウンセリングやセラピーが必要</span
              ></label
            >
            <label
              ><input type="checkbox" value="meds" /><span
                data-i18n="D.options.meds"
                >薬のことで助けが必要</span
              ></label
            >
          </div>
          <div class="btn-row">
            <button
              class="btn btn-success"
              id="evaluate"
              data-i18n="D.showResults"
            >
              結果を表示
            </button>
          </div>
        </section>

        <mh-emergency id="emergency"></mh-emergency>
        <mh-youth id="youth"></mh-youth>
        <mh-adult-crisis id="adult-crisis"></mh-adult-crisis>
        <mh-highcare id="highcare"></mh-highcare>
        <!-- STEP E: 非危機・定型ニーズ（成人） -->
        <section
          id="routine"
          class="result"
          role="region"
          aria-labelledby="routine-title"
        >
          <h3 id="routine-title" data-i18n="routine.title">
            通常の外来サービスにつながる（成人）
          </h3>

          <p data-i18n="routine.body">
            以下の機関は、カウンセリング、薬物療法管理、SUDサポートなどの定型外来を提供しています。
          </p>

          <div class="agency-list">
            <!-- CRS -->
            <article
              class="agency-card"
              data-agency="crs"
              data-site=""
              data-apply=""
            >
              <header class="agency-head">
                <div class="agency-title">
                  <span class="name" data-i18n="routine.crs.full"
                    >Counseling & Recovery Services</span
                  >
                </div>
                <div class="tags">
                  <span class="pill" data-i18n="routine.crs.pill.uninsured"
                    >未保険者OK</span
                  >
                  <span class="pill" data-i18n="routine.crs.pill.sliding"
                    >スライディングスケール</span
                  >
                </div>
              </header>
              <p class="desc" data-i18n="routine.crs.desc">
                オクラホマ州タルサを拠点とする非営利機関。精神健康ケア、カウンセリング、薬物依存治療、危機対応サービスを提供します。
              </p>
              <div class="actions">
                <a class="btn call-btn" href="#" data-i18n="routine.callBtn"
                  >電話する</a
                >
                <a
                  class="btn btn-outline site-btn"
                  href="#"
                  target="_blank"
                  rel="noopener"
                  data-i18n="routine.siteBtn"
                  >ウェブサイト</a
                >
                <a
                  class="btn btn-outline apply-btn"
                  href="#"
                  target="_blank"
                  rel="noopener"
                  data-i18n="routine.applyBtn"
                  >オンライン申込</a
                >
              </div>
            </article>

            <article
              class="agency-card"
              data-agency="fcs"
              data-phone="918-587-9471"
            >
              <header class="agency-head">
                <div class="agency-title">
                  <span class="name" data-i18n="routine.fcs.full"
                    >Family & Children’s Services</span
                  >
                </div>
                <div class="tags">
                  <span class="pill" data-i18n="routine.fcs.pill.sliding"
                    >スライディングスケール</span
                  >
                </div>
              </header>
              <p class="desc" data-i18n="routine.fcs.desc">
                タルサ地域の包括的な子ども・家族支援センター。危機安定化、統合的ヘルスケア、相談・治療サービスを実施しています。
              </p>
              <div class="actions">
                <a class="btn call-btn" href="#" data-i18n="routine.callBtn"
                  >電話する</a
                >
                <a
                  class="btn btn-outline site-btn"
                  href="#"
                  target="_blank"
                  rel="noopener"
                  data-i18n="routine.siteBtn"
                  >ウェブサイト</a
                >
                <a
                  class="btn btn-outline apply-btn"
                  href="#"
                  target="_blank"
                  rel="noopener"
                  data-i18n="routine.applyBtn"
                  >オンライン申込</a
                >
              </div>
            </article>

            <article
              class="agency-card"
              data-agency="chc"
              data-phone="918-622-0641"
            >
              <header class="agency-head">
                <div class="agency-title">
                  <span class="name" data-i18n="routine.chc.full"
                    >Community Health Connection</span
                  >
                </div>
                <div class="tags">
                  <span class="pill" data-i18n="routine.chc.pill.pc"
                    >プライマリケア統合</span
                  >
                  <span class="pill" data-i18n="routine.chc.pill.sliding"
                    >スライディングスケール</span
                  >
                </div>
              </header>
              <p class="desc" data-i18n="routine.chc.desc">
                連邦認定のコミュニティ健康センター（FQHC）。医療、歯科、行動健康、薬局サービスを提供し、保険未加入者にはスライディングスケールの支払制度があります。
              </p>
              <div class="actions">
                <a class="btn call-btn" href="#" data-i18n="routine.callBtn"
                  >電話する</a
                >
                <a
                  class="btn btn-outline site-btn"
                  href="#"
                  target="_blank"
                  rel="noopener"
                  data-i18n="routine.siteBtn"
                  >ウェブサイト</a
                >
                <a
                  class="btn btn-outline apply-btn"
                  href="#"
                  target="_blank"
                  rel="noopener"
                  data-i18n="routine.applyBtn"
                  >オンライン申込</a
                >
              </div>
            </article>
          </div>

          <div class="divider"></div>
          <button class="btn btn-outline" data-reset data-i18n="reset">
            最初の質問に戻る
          </button>
        </section>

        <!-- 安心メッセージ -->
        <section class="step" aria-labelledby="reassure-h">
          <h2
            id="reassure-h"
            class="title"
            style="font-size: 20px; margin: 0 0 6px"
            data-i18n="reassure.title"
          >
            費用・言語・プライバシーについて
          </h2>
          <p class="subtitle" data-i18n="reassure.subtitle">
            あなたは一人ではありません。保険の有無や支払い能力にかかわらず、利用できる支援があります。多くのサービスは無料、または収入に応じた割引料金で提供されています。
          </p>
          <ul>
            <li data-i18n="reassure.lang">
              言語：英語/スペイン語に対応。その他の言語は無料通訳を手配可能。連絡時に希望言語をお伝えください。
            </li>
            <li data-i18n="reassure.immigration">
              移民ステータス：緊急の危機支援サービスを受けるために市民権の証明は不要です。プライバシーは守られます。
            </li>
          </ul>
        </section>

        <!-- FAQ -->
        <section class="step" aria-labelledby="faq-h">
          <h2
            id="faq-h"
            class="title"
            style="font-size: 20px; margin: 0 0 6px"
            data-i18n="faq.title"
          >
            FAQ
          </h2>
          <div class="grid" style="grid-template-columns: 1fr; gap: 10px">
            <details>
              <summary data-i18n="faq.cost.q">
                費用はいくらかかりますか？
              </summary>
              <p data-i18n="faq.cost.a">
                危機サービスは無料です。通常のケアでも、所得に応じた割引（スライディングスケール）が利用できます。費用が障壁になるべきではありません。
              </p>
            </details>
            <details>
              <summary data-i18n="faq.address.q">
                定まった住所がなくても大丈夫ですか？
              </summary>
              <p data-i18n="faq.address.a">
                ホームレス状態でもサービスの対象です。固定の住所は必要ありません。
              </p>
            </details>
            <details>
              <summary data-i18n="faq.privacy.q">
                私の情報は秘密にされますか？
              </summary>
              <p data-i18n="faq.privacy.a">
                サービスは機密であり、情報は法律で保護されます。危害のおそれがある場合を除き、書面での同意なしに情報が共有されることはありません。
              </p>
            </details>
          </div>
          <p class="footer" data-i18n="faq.footer">
            免責：このツールは緊急対応用ではありません。緊急時は 911 / 988 /
            COPES に直接連絡してください。地域の提供範囲（タルサ郡
            ほか）にご注意ください。
          </p>
        </section>
      </main>
    </div>

    <script src="i18n.js"></script>
    <script>
      // DOM ヘルパー
      const $ = (s, root = document) => root.querySelector(s);
      const $$ = (s, root = document) => Array.from(root.querySelectorAll(s));

      // Helper: current Highcare section ID (from component)
      function getHighcareId() {
        const host = document.querySelector("mh-highcare");
        return (
          host?.getAttribute("data-section-id") ||
          host?.querySelector("section[id]")?.id ||
          "highcare"
        );
      }

      // セクション制御
      function hideSections(ids) {
        ids.forEach((id) =>
          document.getElementById(id)?.classList.add("hidden")
        );
      }

      function showSection(id) {
        const el = document.getElementById(id);
        if (el) {
          el.classList.remove("hidden");
          el.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      }

      // 初期状態に戻す
      function resetWizard() {
        const allSections = [
          "stepB",
          "stepC",
          "stepD",
          "youth",
          "adult-crisis",
          "emergency",
          getHighcareId(),
          "routine",
        ];
        hideSections(allSections);

        // チェックをクリア
        $$("#stepD input[type=checkbox]").forEach((cb) => (cb.checked = false));

        showSection("stepA");
        $("#stepA button")?.focus();
      }

      // 次のステップに進む処理
      function goToNextStep(target) {
        const hc = getHighcareId();
        switch (target) {
          case "emergency":
            hideSections([
              "stepB",
              "stepC",
              "stepD",
              "youth",
              "adult-crisis",
              hc,
              "routine",
            ]);
            break;
          case "stepB":
            hideSections([
              "emergency",
              "youth",
              "stepC",
              "stepD",
              "adult-crisis",
              hc,
              "routine",
            ]);
            break;
          case "stepC":
            hideSections([
              "emergency",
              "youth",
              "stepD",
              "adult-crisis",
              hc,
              "routine",
            ]);
            break;
          case "adult-crisis":
            hideSections(["emergency", "youth", "stepD", hc, "routine"]);
            break;
        }
        showSection(target);
      }

      // Step D の評価ロジック
      function evaluateNeeds() {
        const selected = $$("#stepD input[type=checkbox]:checked").map(
          (cb) => cb.value
        );
        hideSections([getHighcareId(), "routine"]);

        const needsHighCare =
          selected.includes("detox") || selected.includes("psychosis");
        showSection(needsHighCare ? getHighcareId() : "routine");
      }

      // イベント登録
      function initEventListeners() {
        // next ボタン
        $$(
          "#stepA [data-next], #stepB [data-next], #stepC [data-next]"
        ).forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const target = e.currentTarget.getAttribute("data-next");
            goToNextStep(target);
          });
        });

        // reset ボタン（静的セクション）
        $$(
          "#emergency [data-reset], #youth [data-reset], #adult-crisis [data-reset], #routine [data-reset]"
        ).forEach((btn) => {
          btn.addEventListener("click", resetWizard);
        });

        // 追加: 動的に挿入されたセクション用の委任ハンドラ
        document.addEventListener("click", (e) => {
          const resetBtn = e.target.closest("[data-reset]");
          if (resetBtn) {
            e.preventDefault();
            resetWizard();
          }
        });

        // Step D の判定
        $("#evaluate").addEventListener("click", evaluateNeeds);

        // キーボードショートカット（「/」「?」で StepA に戻る）
        document.addEventListener("keydown", (e) => {
          if (
            (e.key === "/" || e.key === "?") &&
            !e.target.closest("input,textarea")
          ) {
            e.preventDefault();
            $("#stepA button")?.focus();
          }
        });
      }

      // ページ読み込み時に初期化（deferred componentsが描画された後に実行）
      window.addEventListener("DOMContentLoaded", () => {
        resetWizard();
        initEventListeners();
      });
    </script>
  </body>
</html>
