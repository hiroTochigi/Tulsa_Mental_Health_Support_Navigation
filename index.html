<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title data-i18n="meta.title">タルサ市 メンタルヘルス支援ナビ（MVP）</title>
    <!-- Base & layout -->
    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" href="css/layout.css" />

    <!-- Components -->
    <link rel="stylesheet" href="css/components/buttons.css" />
    <link rel="stylesheet" href="css/components/forms.css" />
    <link rel="stylesheet" href="css/components/results.css" />
    <link rel="stylesheet" href="css/components/agency.css" />
    <script defer src="js/components/modals/modal.js"></script>
    <script defer src="js/components/modals/chc-rate.js"></script>
    <script defer src="js/components/modals/fcs-rate.js"></script>
    <script defer src="js/components/banner.js"></script>
    <script defer src="js/components/emergency.js"></script>
    <script defer src="js/components/highcare.js"></script>
    <script defer src="js/components/youth.js"></script>
    <script defer src="js/components/adult-crisis.js"></script>
    <script defer src="js/components/routine.js"></script>
    <script defer src="js/components/mhac.js"></script>
    <script defer src="js/components/resources211.js"></script>
  </head>
  <body>
    <div class="container">
      <mh-banner></mh-banner>

      <main class="card" aria-live="polite">
        <h1 class="title" data-i18n="title">タルサ市 メンタルヘルス支援ナビ</h1>
        <p class="subtitle" data-i18n="subtitle">
          このツールは、あなたのニーズに合った支援につながるためのガイドです。いくつかの質問にお答えください（個人情報は保存しません）。
        </p>

        <!-- STEP A: 第一次トリアージ -->
        <section id="stepA" class="step" aria-labelledby="qA">
          <div class="q" id="qA" data-i18n="A.question">
            A.
            あなた、または他の誰かが差し迫った危険にありますか？または医学的な緊急事態ですか？
          </div>
          <div class="btn-row">
            <button
              class="btn btn-danger"
              data-next="emergency"
              data-i18n="A.yes"
            >
              はい（緊急）
            </button>
            <button class="btn" data-next="stepB" data-i18n="A.no">
              いいえ
            </button>
          </div>
        </section>

        <!-- STEP B: 年齢 -->
        <section id="stepB" class="step hidden" aria-labelledby="qB">
          <div class="q" id="qB" data-i18n="B.question">
            B. 助けを必要としているのは18歳以上の方ですか？
          </div>
          <div class="btn-row">
            <button class="btn" data-next="stepC" data-i18n="B.adultYes">
              はい（成人）
            </button>
            <button
              class="btn btn-outline"
              data-next="youth"
              data-i18n="B.minorNo"
            >
              いいえ（未成年）
            </button>
          </div>
        </section>

        <!-- STEP C: 成人・緊急度 -->
        <section id="stepC" class="step hidden" aria-labelledby="qC">
          <div class="q" id="qC" data-i18n="C.question">
            C.
            あなたは危機的な状況にあり、今すぐ、緊急に誰かと話す必要がありますか？
          </div>
          <div class="btn-row">
            <button
              class="btn btn-danger"
              data-next="adult-crisis"
              data-i18n="C.yes"
            >
              はい（今すぐ支援が必要）
            </button>
            <button class="btn" data-next="stepD" data-i18n="C.no">
              いいえ（落ち着いて相談先を探したい）
            </button>
          </div>
        </section>

        <!-- STEP D: 成人・特定ニーズ -->
        <section id="stepD" class="step hidden" aria-labelledby="qD">
          <div class="q" id="qD" data-i18n="D.question">
            D. 本日、助けを求めている主な理由は何ですか？（1つ選択してください）
          </div>
          <div class="radios" role="group" aria-labelledby="qD">
            <label>
              <input type="radio" name="stepD-reason" value="detox" />
              <span data-i18n="D.options.detox"
                >薬物やアルコールの使用を安全にやめたい（デトックス）</span
              >
            </label>
            <label>
              <input type="radio" name="stepD-reason" value="psychosis" />
              <span data-i18n="D.options.psychosis"
                >幻覚や深刻な混乱を経験している</span
              >
            </label>
            <label>
              <input type="radio" name="stepD-reason" value="therapy" />
              <span data-i18n="D.options.therapy"
                >カウンセリングやセラピーが必要</span
              >
            </label>
            <label>
              <input type="radio" name="stepD-reason" value="meds" />
              <span data-i18n="D.options.meds">薬のことで助けが必要</span>
            </label>
            <label>
              <input type="radio" name="stepD-reason" value="mhac" />
              <span data-i18n="D.options.mhac"
                >どこに相談すればよいか分からない・案内がほしい（MHAOK）</span
              >
            </label>
            <label>
              <input type="radio" name="stepD-reason" value="211" />
              <span data-i18n="D.options.211">
                生活の困りごと（食料、家賃、光熱費など）や地域の福祉サービスについて相談したい
              </span>
            </label>
          </div>
        </section>

        <mh-emergency id="emergency"></mh-emergency>
        <mh-youth id="youth"></mh-youth>
        <mh-adult-crisis id="adult-crisis"></mh-adult-crisis>
        <mh-highcare id="highcare"></mh-highcare>
        <mh-routine id="routine"></mh-routine>
        <mh-mhac id="mhac"></mh-mhac>
        <mh-211 id="resources211"></mh-211>

        <!-- 安心メッセージ -->
        <section class="step" aria-labelledby="reassure-h">
          <h2
            id="reassure-h"
            class="title"
            style="font-size: 20px; margin: 0 0 6px"
            data-i18n="reassure.title"
          >
            費用・言語・プライバシーについて
          </h2>
          <p class="subtitle" data-i18n="reassure.subtitle">
            あなたは一人ではありません。保険の有無や支払い能力にかかわらず、利用できる支援があります。多くのサービスは無料、または収入に応じた割引料金で提供されています。
          </p>
          <ul>
            <li data-i18n="reassure.lang">
              言語：英語/スペイン語に対応。その他の言語は無料通訳を手配可能。連絡時に希望言語をお伝えください。
            </li>
            <li data-i18n="reassure.immigration">
              移民ステータス：緊急の危機支援サービスを受けるために市民権の証明は不要です。プライバシーは守られます。
            </li>
          </ul>
        </section>

        <!-- FAQ -->
        <section class="step" aria-labelledby="faq-h">
          <h2
            id="faq-h"
            class="title"
            style="font-size: 20px; margin: 0 0 6px"
            data-i18n="faq.title"
          >
            FAQ
          </h2>
          <div class="grid" style="grid-template-columns: 1fr; gap: 10px">
            <details>
              <summary data-i18n="faq.cost.q">
                費用はいくらかかりますか？
              </summary>
              <p data-i18n="faq.cost.a">
                危機サービスは無料です。通常のケアでも、所得に応じた割引（スライディングスケール）が利用できます。費用が障壁になるべきではありません。
              </p>
            </details>
            <details>
              <summary data-i18n="faq.address.q">
                定まった住所がなくても大丈夫ですか？
              </summary>
              <p data-i18n="faq.address.a">
                ホームレス状態でもサービスの対象です。固定の住所は必要ありません。
              </p>
            </details>
            <details>
              <summary data-i18n="faq.privacy.q">
                私の情報は秘密にされますか？
              </summary>
              <p data-i18n="faq.privacy.a">
                サービスは機密であり、情報は法律で保護されます。危害のおそれがある場合を除き、書面での同意なしに情報が共有されることはありません。
              </p>
            </details>
          </div>
          <p class="footer" data-i18n="faq.footer">
            免責：このツールは緊急対応用ではありません。緊急時は 911 / 988 /
            COPES に直接連絡してください。地域の提供範囲（タルサ郡
            ほか）にご注意ください。
          </p>
        </section>
      </main>
    </div>

    <script src="i18n.js"></script>
    <script>
      // DOM ヘルパー
      const $ = (s, root = document) => root.querySelector(s);
      const $$ = (s, root = document) => Array.from(root.querySelectorAll(s));

      // セクションIDを定数で管理
      const SECTIONS = {
        STEP_A: "stepA",
        STEP_B: "stepB",
        STEP_C: "stepC",
        STEP_D: "stepD",
        YOUTH: "youth",
        ADULT_CRISIS: "adult-crisis",
        EMERGENCY: "emergency",
        HIGHCARE: "highcare",
        ROUTINE: "routine",
        MHAC: "mhac",
        RESOURCES_211: "resources211",
      };

      // Highcare section id is fixed to 'highcare'

      // セクション制御
      function hideSections(ids) {
        ids.forEach((id) =>
          document.getElementById(id)?.classList.add("hidden")
        );
      }

      function showSection(id) {
        const el = document.getElementById(id);
        if (el) {
          el.classList.remove("hidden");
          el.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      }

      // 初期状態に戻す
      function resetWizard() {
        const allSections = [
          SECTIONS.STEP_B,
          SECTIONS.STEP_C,
          SECTIONS.STEP_D,
          SECTIONS.YOUTH,
          SECTIONS.ADULT_CRISIS,
          SECTIONS.EMERGENCY,
          SECTIONS.HIGHCARE,
          SECTIONS.ROUTINE,
          SECTIONS.RESOURCES_211,
        ];
        hideSections(allSections);

        // チェックをクリア
        $$("#stepD input[type=checkbox]").forEach((cb) => (cb.checked = false));

        showSection(SECTIONS.STEP_A);
        $(`#${SECTIONS.STEP_A} button`)?.focus();
      }

      // 次のステップに進む処理
      function goToNextStep(target) {
        switch (target) {
          case SECTIONS.EMERGENCY:
            hideSections([
              SECTIONS.STEP_B,
              SECTIONS.STEP_C,
              SECTIONS.STEP_D,
              SECTIONS.YOUTH,
              SECTIONS.ADULT_CRISIS,
              SECTIONS.HIGHCARE,
              SECTIONS.ROUTINE,
              SECTIONS.RESOURCES_211,
            ]);
            break;
          case SECTIONS.STEP_B:
            hideSections([
              SECTIONS.EMERGENCY,
              SECTIONS.YOUTH,
              SECTIONS.STEP_C,
              SECTIONS.STEP_D,
              SECTIONS.ADULT_CRISIS,
              SECTIONS.HIGHCARE,
              SECTIONS.ROUTINE,
              SECTIONS.RESOURCES_211,
            ]);
            break;
          case SECTIONS.STEP_C:
            hideSections([
              SECTIONS.EMERGENCY,
              SECTIONS.YOUTH,
              SECTIONS.STEP_D,
              SECTIONS.ADULT_CRISIS,
              SECTIONS.HIGHCARE,
              SECTIONS.ROUTINE,
              SECTIONS.RESOURCES_211,
            ]);
            break;
          case SECTIONS.STEP_D:
            hideSections([
              SECTIONS.EMERGENCY,
              SECTIONS.YOUTH,
              SECTIONS.ADULT_CRISIS,
              SECTIONS.HIGHCARE,
              SECTIONS.ROUTINE,
              SECTIONS.RESOURCES_211,
            ]);
            break;
          case SECTIONS.ADULT_CRISIS:
            hideSections([
              SECTIONS.EMERGENCY,
              SECTIONS.YOUTH,
              SECTIONS.STEP_D,
              SECTIONS.HIGHCARE,
              SECTIONS.ROUTINE,
              SECTIONS.RESOURCES_211,
            ]);
            break;
        }
        showSection(target);
      }

      // Step D の評価ロジック
      function evaluateNeeds() {
        const selected = document.querySelector(
          "#stepD input[name='stepD-reason']:checked"
        )?.value;
        hideSections([
          SECTIONS.HIGHCARE,
          SECTIONS.ROUTINE,
          SECTIONS.MHAC,
          SECTIONS.RESOURCES_211,
        ]);

        if (!selected) return; // No selection made

        if (selected === "mhac") {
          showSection(SECTIONS.MHAC);
          return;
        }
        if (selected === "211") {
          showSection(SECTIONS.RESOURCES_211);
          return;
        }

        const needsHighCare = selected === "detox" || selected === "psychosis";
        const routineFocus =
          selected === "therapy" ? "therapy" : selected === "meds" ? "meds" : "all";
        document.querySelector("mh-routine")?.setAttribute("focus", routineFocus);
        showSection(needsHighCare ? SECTIONS.HIGHCARE : SECTIONS.ROUTINE);
      }

      // イベント登録
      function initEventListeners() {
        // next ボタン
        $$(
          `#${SECTIONS.STEP_A} [data-next], #${SECTIONS.STEP_B} [data-next], #${SECTIONS.STEP_C} [data-next]`
        ).forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const target = e.currentTarget.getAttribute("data-next");
            goToNextStep(target);
          });
        });

        // reset ボタン（静的セクション）
        $$(
          `#${SECTIONS.EMERGENCY} [data-reset], #${SECTIONS.YOUTH} [data-reset], #${SECTIONS.ADULT_CRISIS} [data-reset], #${SECTIONS.ROUTINE} [data-reset], #${SECTIONS.MHAC} [data-reset], #${SECTIONS.RESOURCES_211} [data-reset]`
        ).forEach((btn) => {
          btn.addEventListener("click", resetWizard);
        });

        // 追加: 動的に挿入されたセクション用の委任ハンドラ
        document.addEventListener("click", (e) => {
          const resetBtn = e.target.closest("[data-reset]");
          if (resetBtn) {
            e.preventDefault();
            resetWizard();
          }
        });

        // Step D の判定
        $$("#stepD input[name='stepD-reason']").forEach((radio) => {
          radio.addEventListener("change", evaluateNeeds);
        });

        // キーボードショートカット（「/」「?」で StepA に戻る）
        document.addEventListener("keydown", (e) => {
          if (
            (e.key === "/" || e.key === "?") &&
            !e.target.closest("input,textarea")
          ) {
            e.preventDefault();
            $(`#${SECTIONS.STEP_A} button`)?.focus();
          }
        });
      }

      // ページ読み込み時に初期化（deferred componentsが描画された後に実行）
      window.addEventListener("DOMContentLoaded", () => {
        resetWizard();
        initEventListeners();
      });
    </script>
  </body>
</html>
